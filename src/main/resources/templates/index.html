<!DOCTYPE HTML>
<html manifest="">

<head th:insert="~{head}">
</head>

<body class="skin-black layout-top-nav" style="height: auto; min-height: 100%;">

	<div class="wrapper" style="height: auto; min-height: 100%;">
		
		<header class="main-header" th:insert="~{navbar}"></header>

		<div class="content-wrapper" style="position: relative; min-height: 600px;">
		    <section class="content">
		      <div class="row">
		        
				<div class="col-md-3">
					<div class="box box-solid">
						<div class="box-header with-border">
						<div class="input-group">
							<input type="text" id="searchInput" class="form-control" placeholder="Localizar...">
							<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
						</div>
					</div>	
						<div class="box-body tree-container" id="tree-container" style="height: 400px; overflow-y: auto;">
						</div>
						<div id="disk-info-footer1" class="box-footer" style="height: 30px; background-color: #f5f5f5; overflow: hidden;">
							&nbsp;
						</div>
					</div>
		        </div>

		        <div class="col-md-9">
		          <div class="box box-primary">
		            <div class="box-header with-border" style="display: flex; align-items: center;">
		              <h3 class="box-title" style="margin: 0;">&nbsp;</h3>
					  <div style="display: flex; gap: 10px; margin-left: 15px;">
						<button id="add-diecast-button" class="btn btn-primary btn-sm" title="Novo Item"><i class="fa fa-plus"></i></button>
						<button id="edit-diecast-button" class="btn btn-default btn-sm" style="display: none;" title="Editar Item"><i class="fa fa-pencil"></i></button>
						<button id="delete-diecast-button" class="btn btn-danger btn-sm" style="display: none;" title="Excluir Item"><i class="fa fa-trash"></i></button>
						<button id="manage-categories-button" class="btn btn-info btn-sm" title="Gerenciar Categorias"><i class="fa fa-cog"></i></button>
						<a href="/carrinho/export/pdf" class="btn btn-default btn-sm" title="Exportar para PDF"><i class="fa fa-file-pdf-o"></i></a>
						<a href="/carrinho/export/pdf/pictures" class="btn btn-default btn-sm" title="Exportar PDF com fotos"><i class="fa fa-file-image-o"></i></a>
						<a href="/carrinho/export/pdf/alphabetical" class="btn btn-default btn-sm" title="Exportar PDF (A-Z)"><i class="fa fa-sort-alpha-asc"></i></a>
						<a href="/carrinho/export/pdf/unchecked" class="btn btn-default btn-sm" title="Exportar não checados para PDF"><i class="fa fa-list-ul"></i></a>
						<a href="/check" class="btn btn-success btn-sm" title="Checagem Rápida"><i class="fa fa-check-square-o"></i></a>
						<a href="/display" class="btn btn-warning btn-sm" title="Expositores"><i class="fa fa-th"></i></a>
					  </div>
		            </div>
		            <div class="box-body" id="main-conteiner">
		            </div>
					<div id="file-info-footer1" class="box-footer" style="height: 30px; background-color: #f5f5f5; overflow: hidden;">
						&nbsp;
					</div>
		          </div>
		        </div>
		      </div>
		    </section>
		  </div>
		<footer th:insert="~{footer}" class="main-footer">
		</footer>

	</div>

	<script src="/adminlte/bower_components/jquery/dist/jquery.min.js"></script>
	<script	src="/adminlte/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="/adminlte/dist/js/adminlte.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		
	<script src="/common/script.js"></script>
	<script src="/common/upload.js"></script>
	<script>
		$(document).ready(function() {
			const treeContainer = document.getElementById('tree-container');
			const mainContainer = document.getElementById('main-conteiner');
			const searchInput = document.getElementById('searchInput');
			const addDiecastButton = document.getElementById('add-diecast-button');
			const editDiecastButton = document.getElementById('edit-diecast-button');
			const deleteDiecastButton = document.getElementById('delete-diecast-button');
			const manageCategoriesButton = document.getElementById('manage-categories-button');

			let currentCarrinho = null;
			let imageData = null;

			// Modal for taking a photo
			const photoModal = `
				<div class="modal fade" id="photo-modal" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title">Tirar Foto</h4>
							</div>
							<div class="modal-body">
								<video id="camera-stream" width="100%" autoplay></video>
								<canvas id="photo-canvas" style="display:none;"></canvas>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
								<button type="button" id="capture-photo-button" class="btn btn-primary">Capturar</button>
							</div>
						</div>
					</div>
				</div>
			`;
			document.body.insertAdjacentHTML('beforeend', photoModal);

			document.getElementById('capture-photo-button').addEventListener('click', function() {
				const video = document.getElementById('camera-stream');
				const canvas = document.getElementById('photo-canvas');
				const context = canvas.getContext('2d');
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				context.drawImage(video, 0, 0, canvas.width, canvas.height);
				imageData = canvas.toDataURL('image/png');
				$('#photo-modal').modal('hide');
			});

			$('#photo-modal').on('hidden.bs.modal', function () {
				const video = document.getElementById('camera-stream');
				const stream = video.srcObject;
				if (stream) {
					const tracks = stream.getTracks();
					tracks.forEach(track => track.stop());
					video.srcObject = null;
				}
			});

			function showDetails(id) {
				fetch('/carrinho/' + id)
					.then(response => response.json())
					.then(carrinho => {
						currentCarrinho = carrinho; // Set the current selection
						editDiecastButton.style.display = 'inline-block';
						deleteDiecastButton.style.display = 'inline-block'; // Show the delete button // Show the edit button
						mainContainer.innerHTML = ''; // Clear previous content

						const row = document.createElement('div');
						row.className = 'row';

						// Image column
						const imageCol = document.createElement('div');
						imageCol.className = 'col-md-5';

						const imageContainer = document.createElement('div');
						imageContainer.style.height = '250px';
						imageContainer.style.width = '100%';
						imageContainer.style.marginTop = '20px';
						imageContainer.style.border = '1px solid #ddd';
						imageContainer.style.borderRadius = '4px';
						imageContainer.style.overflow = 'hidden';
						imageContainer.style.display = 'flex';
						imageContainer.style.justifyContent = 'center';
						imageContainer.style.alignItems = 'center';

						if (carrinho.imagem) {
							const img = document.createElement('img');
							img.src = carrinho.imagem;
							img.style.width = '100%';
							img.style.height = '100%';
							img.style.objectFit = 'contain';
							imageContainer.appendChild(img);
						} else {
							imageContainer.innerHTML = '<i class="fa fa-camera fa-5x text-muted"></i>';
						}
						imageCol.appendChild(imageContainer);

						// Details column
						const detailsCol = document.createElement('div');
						detailsCol.className = 'col-md-7';
						
						const title = document.createElement('h3');
						title.style.borderBottom = '2px solid #f4f4f4';
						title.style.paddingBottom = '10px';
						title.style.marginBottom = '20px';
						title.textContent = carrinho.descricao;
						detailsCol.appendChild(title);

						const detailsContainer = document.createElement('div');

						// Código
						const codigoRow = document.createElement('div');
						codigoRow.className = 'row';
						codigoRow.innerHTML = `
							<div class="col-sm-4"><strong>Código</strong></div>
							<div class="col-sm-8">${carrinho.codigo}</div>
						`;
						detailsContainer.appendChild(codigoRow);

						// Categoria
						if (carrinho.categoria) {
							const categoriaRow = document.createElement('div');
							categoriaRow.className = 'row';
							categoriaRow.style.marginTop = '10px';
							categoriaRow.innerHTML = `
								<div class="col-sm-4"><strong>Categoria</strong></div>
								<div class="col-sm-8">
									${carrinho.categoria.nome}<br>
									<small>${carrinho.categoria.descricao}</small>
								</div>
							`;
							detailsContainer.appendChild(categoriaRow);
						}
 
						// Checado
						const checadoRow = document.createElement('div');
						checadoRow.className = 'row';
						checadoRow.style.marginTop = '10px';
						checadoRow.innerHTML = `
							<div class="col-sm-4"><strong>Checado</strong></div>
							<div class="col-sm-8">${carrinho.checked ? 'Sim' : 'Não'}</div>
						`;
						detailsContainer.appendChild(checadoRow);

						// Expositor e Célula
						const expositorRow = document.createElement('div');
						expositorRow.className = 'row';
						expositorRow.style.marginTop = '10px';
						expositorRow.innerHTML = `
							<div class="col-sm-4"><strong>Expositor / Célula</strong></div>
							<div class="col-sm-8">${carrinho.displayCode ? carrinho.displayCode + ' - ' + (carrinho.cellCode || 'N/A') : 'N/A'}</div>
						`;
						detailsContainer.appendChild(expositorRow);

						detailsCol.appendChild(detailsContainer);
						
						row.appendChild(imageCol);
						row.appendChild(detailsCol);
						mainContainer.appendChild(row);
					});
			}

			function updateList(data) {
				treeContainer.innerHTML = '';
				const table = document.createElement('table');
				table.className = 'table table-hover';

				const thead = document.createElement('thead');
				thead.innerHTML = `
					<tr>
						<th style="width: 80px;">Código</th>
						<th>Nome</th>
					</tr>
				`;
				table.appendChild(thead);

				const tbody = document.createElement('tbody');
				data.forEach(item => {
					const tr = document.createElement('tr');
					tr.style.cursor = 'pointer';
					tr.setAttribute('data-id', item.id);
					
					const tdCodigo = document.createElement('td');
					tdCodigo.textContent = item.codigo;
					
					const tdDescricao = document.createElement('td');
					tdDescricao.textContent = item.descricao;

					tr.appendChild(tdCodigo);
					tr.appendChild(tdDescricao);

					tr.addEventListener('click', function() {
						showDetails(this.getAttribute('data-id'));
					});
					
					tbody.appendChild(tr);
				});
				table.appendChild(tbody);
				treeContainer.appendChild(table);
			}

			function fetchInitialList() {
				fetch('/carrinho/initial')
					.then(response => response.json())
					.then(data => {
						updateList(data);
						if (data.length > 0) {
							showDetails(data[0].id); // Display details of the first item
						}
						updateTotalDiecastCount(); // Update total count after initial list load
					});
			}

			function updateTotalDiecastCount() {
				fetch('/carrinho/count')
					.then(response => response.json())
					.then(count => {
						document.getElementById('disk-info-footer1').innerHTML = `Total de Itens: <b>${count}</b>`;
					})
					.catch(error => {
						console.error("Error fetching total diecast count: ", error);
						document.getElementById('disk-info-footer1').innerHTML = `Total de Itens: <b>Erro</b>`;
					});
			}

			function showNewDiecastForm() {
				currentCarrinho = null;
				editDiecastButton.style.display = 'none';
				deleteDiecastButton.style.display = 'none';
				fetch('/categoria-carrinho')
					.then(response => response.json())
					.then(categories => {
						mainContainer.innerHTML = `
							<form id="new-diecast-form">
								<div class="form-group">
									<label for="codigo">Código</label>
									<input type="text" class="form-control" id="codigo" oninput="this.value = this.value.toUpperCase()" required>
								</div>
								<div class="form-group">
									<label for="descricao">Descrição</label>
									<input type="text" class="form-control" id="descricao" required>
								</div>
								<div class="form-group">
									<label for="categoria">Categoria</label>
									<select class="form-control" id="categoria">
										${categories.map(cat => `<option value="${cat.id}">${cat.nome}</option>`).join('')}
									</select>
								</div>
								<div class="form-group">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="checked"> Checado
										</label>
									</div>
								</div>
								<div class="form-group">
									<label for="imagem">Imagem</label>
									<div class="input-group">
										<input type="file" class="form-control" id="imagem" accept="image/*">
										<span class="input-group-btn">
											<button type="button" class="btn btn-default" id="take-photo-button">Tirar Foto</button>
										</span>
									</div>
								</div>
								<div class="text-right">
									<button type="submit" class="btn btn-primary">Salvar</button>
									<button type="button" id="cancel-diecast-button" class="btn btn-default">Cancelar</button>
								</div>
							</form>
						`;

						document.getElementById('take-photo-button').addEventListener('click', function() {
							$('#photo-modal').modal('show');
							const video = document.getElementById('camera-stream');
							navigator.mediaDevices.getUserMedia({ video: true })
								.then(stream => {
									video.srcObject = stream;
								})
								.catch(err => {
									console.error("Error accessing camera: ", err);
									Swal.fire('Erro!', 'Não foi possível acessar a câmera.', 'error');
								});
						});


						document.getElementById('imagem').addEventListener('change', function(event) {
							const file = event.target.files[0];
							if (file) {
								const reader = new FileReader();
								reader.onload = function(e) {
									imageData = e.target.result;
								};
								reader.readAsDataURL(file);
							}
						});

						document.getElementById('cancel-diecast-button').addEventListener('click', function() {
							mainContainer.innerHTML = '';
							editDiecastButton.style.display = 'none';
							deleteDiecastButton.style.display = 'none';
						});
						
						document.getElementById('new-diecast-form').addEventListener('submit', function(event) {
							event.preventDefault();
							
							const submitButton = this.querySelector('button[type="submit"]');
							submitButton.disabled = true;
							submitButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';

							const newCarrinho = {
								codigo: document.getElementById('codigo').value,
								descricao: document.getElementById('descricao').value,
								categoria: {
									id: document.getElementById('categoria').value
								},
								checked: document.getElementById('checked').checked,
								imagem: imageData
							};

							fetch('/carrinho', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(newCarrinho),
							})
							.then(async response => {
								if (!response.ok) {
									const text = await response.text();
									throw new Error(text || 'Ocorreu um erro ao salvar.');
								}
								return response.json();
							})
							.then(savedCarrinho => {
								Swal.fire('Salvo!','Novo item da coleção salvo com sucesso.','success');
								fetchInitialList();
								mainContainer.innerHTML = '';
								editDiecastButton.style.display = 'none';
								deleteDiecastButton.style.display = 'none';
								updateTotalDiecastCount(); // Update count after saving new item
							})
							.catch(error => {
								Swal.fire('Erro!', error.message, 'error');
							});
						});
					});
			}

			function showEditDiecastForm(carrinho) {
				let imageData = carrinho.imagem;
				editDiecastButton.style.display = 'inline-block';
				deleteDiecastButton.style.display = 'none';
				fetch('/categoria-carrinho')
					.then(response => response.json())
					.then(categories => {
						mainContainer.innerHTML = `
							<form id="edit-diecast-form">
								<h3>Editar Item: ${carrinho.descricao}</h3>
								<div class="form-group">
									<label for="codigo">Código</label>
									<input type="text" class="form-control" id="codigo" value="${carrinho.codigo}" oninput="this.value = this.value.toUpperCase()" required>
								</div>
								<div class="form-group">
									<label for="descricao">Descrição</label>
									<input type="text" class="form-control" id="descricao" value="${carrinho.descricao}" required>
								</div>
								<div class="form-group">
									<label for="categoria">Categoria</label>
									<select class="form-control" id="categoria">
										${categories.map(cat => `<option value="${cat.id}" ${carrinho.categoria && cat.id === carrinho.categoria.id ? 'selected' : ''}>${cat.nome}</option>`).join('')}
									</select>
								</div>
								<div class="form-group">
									<div class="checkbox">
										<label>
											<input type="checkbox" id="checked" ${carrinho.checked ? 'checked' : ''}> Checado
										</label>
									</div>
								</div>
								                                                                <div class="form-group">
								                                                                    <label for="imagem">Alterar Imagem</label>
								                                                                    <div class="input-group">
								                                                                        <input type="file" class="form-control" id="imagem" accept="image/*">
								                                                                        <span class="input-group-btn">
								                                                                            <button type="button" class="btn btn-default" id="take-photo-button">Tirar Foto</button>
								                                                                        </span>
								                                                                    </div>
								                                                                </div>
								                                                                <div class="text-right">
								                                                                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
								                                                                    <button type="button" id="cancel-edit-button" class="btn btn-default">Cancelar</button>
								                                                                </div>
								                                                            </form>
								                                                        `;								
								                                								
								                                							document.getElementById('take-photo-button').addEventListener('click', function() {
								                                								$('#photo-modal').modal('show');
								                                								const video = document.getElementById('camera-stream');
								                                								navigator.mediaDevices.getUserMedia({ video: true })
								                                									.then(stream => {
								                                										video.srcObject = stream;
								                                									})
								                                									.catch(err => {
								                                										console.error("Error accessing camera: ", err);
								                                										Swal.fire('Erro!', 'Não foi possível acessar a câmera.', 'error');
								                                									});
								                                							});
								                                								
								                                							
								                                						document.getElementById('imagem').addEventListener('change', function(event) {
								                                							const file = event.target.files[0];
								                                							if (file) {
								                                								const reader = new FileReader();
								                                								reader.onload = function(e) {
								                                									imageData = e.target.result;
								                                								};
								                                								reader.readAsDataURL(file);
								                                							}
								                                						});
								                                
								                                						document.getElementById('cancel-edit-button').addEventListener('click', function() {
								                                							showDetails(carrinho.id);
								                                						});
								                                						
								                                														                        document.getElementById('edit-diecast-form').addEventListener('submit', function(event) {
								                                														                                							event.preventDefault();
								                                														                                							
								                                																													const submitButton = this.querySelector('button[type="submit"]');
								                                																													submitButton.disabled = true;
								                                																													submitButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Salvando...';
								                                						
								                                														                                							const updatedCarrinho = {								                                								id: carrinho.id,
								                                								codigo: document.getElementById('codigo').value,
								                                								descricao: document.getElementById('descricao').value,
								                                								categoria: {
								                                									id: document.getElementById('categoria').value
								                                								},
								                                								checked: document.getElementById('checked').checked,
								                                								imagem: imageData
								                                							};
								                                
								                                															fetch('/carrinho/' + carrinho.id, {
								                                															                                								method: 'PUT',
								                                															                                								headers: { 'Content-Type': 'application/json' },
								                                															                                								body: JSON.stringify(updatedCarrinho),
								                                															                                							})
								                                															                                
								                                														.then(async response => {
								                                															if (!response.ok) {
								                                																const text = await response.text();
								                                																throw new Error(text || 'Ocorreu um erro ao salvar as alterações.');
								                                															}
								                                															return response.json();
								                                														})
								                                														.then(savedCarrinho => {
								                                															Swal.fire('Salvo!', 'As alterações foram salvas com sucesso.', 'success');
								                                															fetchInitialList();
								                                															showDetails(savedCarrinho.id);
								                                															updateTotalDiecastCount(); // Update count after saving existing item
								                                														})
								                                														.catch(error => {
								                                															Swal.fire('Erro!', error.message, 'error');
								                                														});
								                                													});
								                                												});
								                                										}
			function showManageCategories() {
				                currentCarrinho = null;
				                editDiecastButton.style.display = 'none';
				                deleteDiecastButton.style.display = 'none';
				                mainContainer.innerHTML = `					<div class="box-header with-border">
						<h3 class="box-title">Gerenciar Categorias</h3>
						<div class="box-tools">
							<div class="input-group input-group-sm" style="width: 250px;">
								<input type="text" id="category-search-input" class="form-control pull-right" placeholder="Procurar categoria...">
								<div class="input-group-btn">
									<button type="button" id="add-new-category-btn" class="btn btn-primary"><i class="fa fa-plus"></i> Adicionar</button>
								</div>
							</div>
						</div>
					</div>
					<div class="box-body" id="category-list-container">
						<!-- Category table will be rendered here -->
					</div>
				`;

				const categoryListContainer = document.getElementById('category-list-container');
				categoryListContainer.style.height = '300px';
				categoryListContainer.style.overflowY = 'auto';
				const searchInput = document.getElementById('category-search-input');
				const addButton = document.getElementById('add-new-category-btn');

				function refreshCategoryList() {
					fetch('/categoria-carrinho')
						.then(response => response.json())
						.then(categories => {
							let tableHtml = `
								<table class="table table-hover">
									<thead>
										<tr>
											<th>Nome</th>
											<th>Descrição</th>
											<th style="width: 100px;">Ações</th>
										</tr>
									</thead>
									<tbody>
							`;
							categories.forEach(cat => {
								tableHtml += `
									<tr data-id="${cat.id}" data-name="${cat.nome}" data-description="${cat.descricao}">
										<td>${cat.nome}</td>
										<td>${cat.descricao}</td>
										<td>
											<button class="btn btn-xs btn-default btn-edit-cat"><i class="fa fa-pencil"></i></button>
											<button class="btn btn-xs btn-danger btn-delete-cat"><i class="fa fa-trash"></i></button>
										</td>
									</tr>
								`;
							});
							tableHtml += '</tbody></table>';
							categoryListContainer.innerHTML = tableHtml;
						});
				}

				// Add New Category
				addButton.addEventListener('click', () => {
					Swal.fire({
						title: 'Nova Categoria',
						html:
							'<input id="swal-input-nome" class="swal2-input" placeholder="Nome">' +
							'<input id="swal-input-descricao" class="swal2-input" placeholder="Descrição">',
						focusConfirm: false,
						showCancelButton: true,
						confirmButtonText: 'Salvar',
						cancelButtonText: 'Cancelar',
						preConfirm: () => {
							const nome = document.getElementById('swal-input-nome').value;
							const descricao = document.getElementById('swal-input-descricao').value;
							if (!nome || !descricao) {
								Swal.showValidationMessage(`Por favor, preencha ambos os campos`);
							}
							return { nome: nome, descricao: descricao };
						}
					}).then((result) => {
						if (result.isConfirmed) {
							const newCategoria = { nome: result.value.nome, descricao: result.value.descricao };
							fetch('/categoria-carrinho', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(newCategoria),
							})
							.then(response => {
								if (!response.ok) throw new Error('Network response was not ok');
								return response.json();
							})
							.then(() => {
								Swal.fire('Salvo!', 'Nova categoria criada com sucesso.', 'success');
								refreshCategoryList();
							})
							.catch(error => Swal.fire('Erro!', 'Ocorreu um erro ao salvar.', 'error'));
						}
					});
				});

				// Edit and Delete listeners (using event delegation)
				categoryListContainer.addEventListener('click', function(event) {
					const target = event.target.closest('button');
					if (!target) return;

					const tr = target.closest('tr');
					const catId = tr.dataset.id;
					const catName = tr.dataset.name;
					const catDescription = tr.dataset.description;

					// Edit action
					if (target.classList.contains('btn-edit-cat')) {
						Swal.fire({
							title: 'Editar Categoria',
							html:
								`<input id="swal-input-nome" class="swal2-input" placeholder="Nome" value="${catName}">` +
								`<input id="swal-input-descricao" class="swal2-input" placeholder="Descrição" value="${catDescription}">`,
							focusConfirm: false,
							showCancelButton: true,
							confirmButtonText: 'Salvar Alterações',
							cancelButtonText: 'Cancelar',
							preConfirm: () => {
								const nome = document.getElementById('swal-input-nome').value;
								const descricao = document.getElementById('swal-input-descricao').value;
								if (!nome || !descricao) {
									Swal.showValidationMessage(`Por favor, preencha ambos os campos`);
								}
								return { nome: nome, descricao: descricao };
							}
						}).then((result) => {
							if (result.isConfirmed) {
								const updatedCategoria = { id: catId, nome: result.value.nome, descricao: result.value.descricao };
								fetch('/categoria-carrinho/' + catId, {
									method: 'PUT',
									headers: { 'Content-Type': 'application/json' },
									body: JSON.stringify(updatedCategoria),
								})
								.then(response => {
									if (!response.ok) throw new Error('Network response was not ok');
									return response.json();
								})
								.then(() => {
									Swal.fire('Salvo!', 'Categoria atualizada com sucesso.', 'success');
									refreshCategoryList();
								})
								.catch(error => Swal.fire('Erro!', 'Ocorreu um erro ao salvar.', 'error'));
							}
						});
					}

					// Delete action
					if (target.classList.contains('btn-delete-cat')) {
						Swal.fire({
							title: 'Você tem certeza?',
							text: `Deseja realmente excluir a categoria "${catName}"?`,
							icon: 'warning',
							showCancelButton: true,
							confirmButtonColor: '#d33',
							cancelButtonColor: '#3085d6',
							confirmButtonText: 'Sim, excluir!',
							cancelButtonText: 'Cancelar'
						}).then((result) => {
							if (result.isConfirmed) {
								fetch('/categoria-carrinho/' + catId, {
									method: 'DELETE',
								})
								.then(response => {
									if (!response.ok) {
										return response.text().then(text => { throw new Error(text || 'Não foi possível excluir. Verifique se a categoria não está em uso.') });
									}
									Swal.fire('Excluído!', 'A categoria foi excluída.', 'success');
									refreshCategoryList();
								})
								.catch(error => Swal.fire('Erro!', error.message || 'Ocorreu um erro ao excluir.', 'error'));
							}
						});
					}
				});

				// Client-side search
				searchInput.addEventListener('keyup', function() {
					const searchTerm = searchInput.value.toLowerCase();
					const rows = categoryListContainer.querySelectorAll('tbody tr');
					rows.forEach(row => {
						const name = row.dataset.name.toLowerCase();
						const description = row.dataset.description.toLowerCase();
						if (name.includes(searchTerm) || description.includes(searchTerm)) {
							row.style.display = '';
						} else {
							row.style.display = 'none';
						}
					});
				});

				refreshCategoryList(); // Initial load
			}

			function deleteDiecastItem(id) {
				Swal.fire({
					title: 'Você tem certeza?',
					text: "Você não será capaz de reverter isso!",
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#3085d6',
					cancelButtonColor: '#d33',
					confirmButtonText: 'Sim, deletar!',
					cancelButtonText: 'Cancelar'
				}).then((result) => {
					if (result.isConfirmed) {
						fetch('/carrinho/' + id, {
							method: 'DELETE',
						})
						.then(response => {
							if (!response.ok) {
								return response.text().then(text => { throw new Error(text || 'Não foi possível excluir o item.') });
							}
							Swal.fire(
								'Deletado!',
								'O item foi excluído.',
								'success'
							)
							fetchInitialList();
							mainContainer.innerHTML = '';
							editDiecastButton.style.display = 'none';
							deleteDiecastButton.style.display = 'none';
							updateTotalDiecastCount(); // Update count after deleting item
						})
						.catch(error => {
							Swal.fire(
								'Erro!',
								error.message || 'Ocorreu um erro ao excluir o item.',
								'error'
							)
						});
					}
				})
			}
			
			addDiecastButton.addEventListener('click', function() {
				showNewDiecastForm();
			});

			editDiecastButton.addEventListener('click', function() {
				if (currentCarrinho) {
					showEditDiecastForm(currentCarrinho);
				}
			});

			deleteDiecastButton.addEventListener('click', function() {
				if (currentCarrinho && currentCarrinho.id) {
					deleteDiecastItem(currentCarrinho.id);
				}
			});

			manageCategoriesButton.addEventListener('click', function() {
				currentCarrinho = null;
				editDiecastButton.style.display = 'none';
				showManageCategories();
			});

			searchInput.addEventListener('keyup', function() {
				mainContainer.innerHTML = ''; 
				currentCarrinho = null;
				editDiecastButton.style.display = 'none';
				deleteDiecastButton.style.display = 'none';
				const searchTerm = this.value;
				if (searchTerm.length > 2) {
					fetch('/carrinho/search/' + searchTerm)
						.then(response => response.json())
						.then(data => updateList(data));
				} else if (searchTerm.length === 0) {
					fetchInitialList();
				}
			});

			// Initial load
			fetchInitialList();

			$('#logout-link').on('click', function(e) {
				e.preventDefault();
				$('#logout-form').submit();
			});
		});
	</script>
</body>
