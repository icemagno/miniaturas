<!DOCTYPE HTML>
<html manifest="">

<head th:insert="~{head}">
</head>

<body class="skin-black layout-top-nav" style="height: auto; min-height: 100%;">

	<div class="wrapper" style="height: auto; min-height: 100%;">
		
		<header class="main-header" th:insert="~{navbar}"></header>

		<div class="content-wrapper" style="position: relative; min-height: 600px;">
		    <section class="content">
		      <div class="row">
		        <div class="col-md-6 col-md-offset-3">
		          <div class="box box-primary">
		            <div class="box-header with-border">
		              <h3 class="box-title">Checagem Rápida</h3>
		              <div class="box-tools pull-right">
		                <a href="/carrinho/export/pdf/unchecked" class="btn btn-warning btn-sm" title="Exportar não checados para PDF"><i class="fa fa-file-pdf-o"></i></a>
		                <a href="/carrinho/export/pdf/checked" class="btn btn-success btn-sm" title="Exportar checados para PDF"><i class="fa fa-file-pdf-o"></i></a>
		                <button id="reset-checked-button" class="btn btn-danger btn-sm" title="Resetar todos para não checado"><i class="fa fa-refresh"></i></button>
		              </div>
		            </div>
		            <div class="box-body">
		              <div class="form-group">
		                <label for="codigoInput">Código da Miniatura</label>
		                <input type="text" class="form-control" id="codigoInput" placeholder="Digite o código e pressione Enter" oninput="this.value = this.value.toUpperCase()">
		              </div>
		            </div>
		                        <div class="box-footer">
		                          <h4>Últimos 5 checados:</h4>
		                          <ul id="lastCheckedList" class="list-group">
		                          </ul>
		                          <div class="text-right" style="margin-top: 20px;">
		                            <a href="/" class="btn btn-default">Voltar para o Início</a>
		                          </div>
		                        </div>		          </div>
		        </div>
		      </div>
		    </section>
		  </div>
		<footer th:insert="~{footer}" class="main-footer">
		</footer>

	</div>

	<script src="/adminlte/bower_components/jquery/dist/jquery.min.js"></script>
	<script	src="/adminlte/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="/adminlte/dist/js/adminlte.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		
	<script>
		$(document).ready(function() {
			const codigoInput = document.getElementById('codigoInput');
			const lastCheckedList = document.getElementById('lastCheckedList');
			const resetCheckedButton = document.getElementById('reset-checked-button');
			let lastChecked = [];

			function updateLastCheckedList() {
				lastCheckedList.innerHTML = '';
				lastChecked.forEach(item => {
					const li = document.createElement('li');
					li.className = 'list-group-item';
					li.textContent = `${item.codigo} - ${item.descricao}`;
					lastCheckedList.appendChild(li);
				});
			}

			codigoInput.addEventListener('keypress', function(event) {
				if (event.key === 'Enter') {
					event.preventDefault();
					const codigo = this.value;
					if (codigo) {
						fetch('/carrinho/check/' + codigo, {
							method: 'POST'
						})
						.then(response => {
							if (response.ok) {
								return response.json();
							}
							throw new Error('Miniatura não encontrada');
						})
						.then(carrinho => {
							lastChecked.unshift(carrinho);
							if (lastChecked.length > 5) {
								lastChecked.pop();
							}
							updateLastCheckedList();
							this.value = '';
							Swal.fire({
								toast: true,
								position: 'top-end',
								icon: 'success',
								title: 'Checado!',
								showConfirmButton: false,
								timer: 1500
							});
						})
						.catch(error => {
							Swal.fire('Erro!', error.message, 'error');
						});
					}
				}
			});

			resetCheckedButton.addEventListener('click', function() {
				Swal.fire({
					title: 'Você tem certeza?',
					text: "Esta ação irá marcar TODOS os itens como NÃO CHECADOS. Você não poderá reverter isso!",
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#d33',
					cancelButtonColor: '#3085d6',
					confirmButtonText: 'Sim, resetar!',
					cancelButtonText: 'Cancelar'
				}).then((result) => {
					if (result.isConfirmed) {
						fetch('/carrinho/reset-checked', {
							method: 'POST'
						})
						.then(response => {
							if (response.ok) {
								Swal.fire(
									'Resetado!',
									'Todos os itens foram marcados como não checados.',
									'success'
								)
								lastChecked = [];
								updateLastCheckedList();
							} else {
								throw new Error('Ocorreu um erro ao resetar os itens.');
							}
						})
						.catch(error => {
							Swal.fire(
								'Erro!',
								error.message,
								'error'
							)
						});
					}
				})
			});
		});
	</script>
</body>
</html>
